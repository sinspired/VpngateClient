name: Build and Release
on:
  push:
    tags:
      - "v*"
  release:
    types: [created]

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            arch: amd64
            pyinstaller-arch: ""
          - os: ubuntu-latest
            platform: Linux
            arch: arm64
            pyinstaller-arch: "--target-arch aarch64"
          - os: windows-latest
            platform: Windows
            arch: x64
            pyinstaller-arch: ""
          - os: macos-latest
            platform: macOS
            arch: amd64
            pyinstaller-arch: ""
          - os: macos-latest
            platform: macOS
            arch: arm64
            pyinstaller-arch: "--target-arch arm64"
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Only install requirements.txt on Windows
        if: matrix.os == 'windows-latest'
        run: pip install -r requirements.txt

      - name: Build Windows Executable
        if: matrix.os == 'windows-latest' && matrix.arch == 'x64'
        shell: pwsh
        run: |
          # build onefile exec file
          pyinstaller --onefile --clean --uac-admin --name VpngateClient-${{ matrix.platform }}-${{ matrix.arch }} --icon VpngateClient/logo.ico VpngateClient/VpngateClient.py

          # build onedir portable files
          pyinstaller --onedir --clean --uac-admin --name VpngateClient-${{ matrix.platform }}-${{ matrix.arch }}-Portable --icon VpngateClient/logo.ico VpngateClient/VpngateClient.py

          # zip portable folder
          $outdir = "dist\VpngateClient-${{ matrix.platform }}-${{ matrix.arch }}-Portable"
          Compress-Archive -Path "$outdir\*" -DestinationPath "dist\VpngateClient-${{ matrix.platform }}-${{ matrix.arch }}-Portable.zip" -Force

      - name: Build Linux Executable
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential
          sudo gem install --no-document fpm
          pyinstaller --onefile --clean ${{ matrix.pyinstaller-arch }} --name VpngateClient-${{ matrix.platform }}-${{ matrix.arch }} --icon VpngateClient/logo.png VpngateClient/VpngateClient.py

      - name: Build Linux DEB Package
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          mkdir -p package/usr/local/bin package/usr/share/applications package/usr/share/icons/hicolor/256x256/apps
          cp dist/VpngateClient-${{ matrix.platform }}-${{ matrix.arch }} package/usr/local/bin/VpngateClient
          chmod +x package/usr/local/bin/VpngateClient
          cp ./VpngateClient/logo.png package/usr/share/icons/hicolor/256x256/apps/vpngate-client.png
          cat > package/usr/share/applications/vpngate-client.desktop << 'EOL'
          [Desktop Entry]
          Name=VPN Gate Client
          Exec=VpngateClient
          Icon=vpngate-client
          Type=Application
          Categories=Network;
          Terminal=true
          EOL
          fpm -s dir -t deb -n vpngate-client -v ${GITHUB_REF_NAME#v} -C package .
          mv vpngate-client_*.deb dist/VpngateClient-${{ matrix.platform }}-${{ matrix.arch }}.deb

      - name: Build macOS Executable
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          pyinstaller --onefile --clean ${{ matrix.pyinstaller-arch }} --name VpngateClient-${{ matrix.platform }}-${{ matrix.arch }} --icon VpngateClient/logo.icns VpngateClient/VpngateClient.py

      - name: Package macOS App and DMG
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          mkdir -p dist/VpngateClient.app/Contents/{MacOS,Resources}
          cp dist/VpngateClient-${{ matrix.platform }}-${{ matrix.arch }} dist/VpngateClient.app/Contents/MacOS/VpngateClient
          chmod +x dist/VpngateClient.app/Contents/MacOS/VpngateClient
          cp VpngateClient/logo.icns dist/VpngateClient.app/Contents/Resources/ || true
          cat > dist/VpngateClient.app/Contents/Info.plist << 'EOL'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>VpngateClient</string>
              <key>CFBundleIconFile</key>
              <string>logo</string>
              <key>CFBundleIdentifier</key>
              <string>com.vpngate.client</string>
              <key>CFBundleName</key>
              <string>VPN Gate Client</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleVersion</key>
              <string>${GITHUB_REF_NAME#v}</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOL
          hdiutil create -volname VpngateClient -srcfolder dist/VpngateClient.app -ov -format UDZO dist/VpngateClient-${{ matrix.platform }}-${{ matrix.arch }}.dmg

      - name: Package products into a unified catalog
        shell: bash
        run: |
          mkdir -p release-assets
          shopt -s nullglob
          # åªå¤åˆ¶ dist ä¸‹çš„â€œæ–‡ä»¶â€ï¼Œè·³è¿‡ç›®å½•
          for f in dist/*${{ matrix.platform }}-${{ matrix.arch }}*; do
            if [ -f "$f" ]; then
              cp "$f" "release-assets/"
            fi
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}-executables
          path: |
            dist/VpngateClient-Windows-Portable-x64.zip
            release-assets/*${{ matrix.platform }}-${{ matrix.arch }}*

  create-release:
    needs: build
    runs-on: ubuntu-latest
    permissions: { contents: write }

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: Prepare release files
        run: |
          mkdir -p release-assets
          find release-files -type f -exec cp {} release-assets/ \;
          # ç¡®è®¤æ–‡ä»¶å·²å¤åˆ¶
          echo "Files in release-assets directory:"
          ls -la release-assets/

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-creatordate \
            | grep -v "^${{ github.ref_name }}$" \
            | head -n1)
          echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Get full changelog since previous tag
        id: changelog
        run: |
          if [ -n "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            RANGE="${{ steps.prev_tag.outputs.prev_tag }}..${{ github.ref_name }}"
          else
            RANGE=""
          fi
          
          # ä½¿ç”¨ **%s** æ¸²æŸ“æ ‡é¢˜ä¸ºç²—ä½“ï¼Œ%n%n ä¿ç•™ç©ºè¡Œï¼Œç„¶åŽ %b è¾“å‡ºæ­£æ–‡
          # 1) ä¸å¸¦ prefix çš„æ ‡é¢˜è¡Œï¼šæ•´è¡ŒåŒ…è£¹
          # 2) å¸¦ prefix çš„æ ‡é¢˜è¡Œï¼šåªåŠ ç²— prefix å¹¶ä¿ç•™ä½™ä¸‹æ–‡å­—
          # 3) éžæ ‡é¢˜è¡Œä¸­çš„ prefixï¼šå…¨å±€åŠ ç²—
          # 4) éžæ ‡é¢˜è¡Œä¸”ä»¥æ•°å­—å¼€å¤´ï¼šç¼©è¿› 2 ç©ºæ ¼å¹¶åŠ ä¸Š "- " å˜æˆäºŒçº§åˆ—è¡¨
          CHANGELOG=$(
              git log -5 $RANGE --pretty=format:'- %s (%h)%n%n%b%n' |
              sed -E \
                  -e '/^- /{ /- (feat|fix|pref|chore):/! s/^- (.*)/- \1/ }' \
                  -e '/^- (feat|fix|pref|chore):/ s/^- (feat|fix|pref|chore):[[:space:]]*(.*)/- **\1:** \2/' \
                  -e '/^- /! s/\b(feat|fix|pref|chore):[[:space:]]*/- **\1:** /g' \
                  -e '/^- /!{ /^[[:digit:]]/ s/^/> / }'
          )

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      - name: Check and delete existing release
        id: check_release
        run: |
          if gh release view ${{ github.ref_name }} &> /dev/null; then
            echo "æ­£åœ¨åˆ é™¤å·²å­˜åœ¨çš„å‘å¸ƒ..."
            gh release delete ${{ github.ref_name }} --yes
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Pre-release Check
        id: pre_release_check
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # é¢„å‘å¸ƒå…³é”®å­—
          if echo "$TAG_NAME" | grep -Eq 'dev|alpha|beta|rc'; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          shopt -s nullglob
          FILES=(release-assets/*)
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No release files found, skipping upload."
            exit 0
          fi

          echo "Release files:"
          ls -lh release-assets/

          cat > RELEASE_NOTES.md <<'EOF'

          ## ðŸ“ Changelog

          ${{ steps.changelog.outputs.changelog }}

          ## ðŸ“¦ Downloads

          | Platform | File |
          |----------|------|
          | Windows x64 | [![windows x64](https://custom-icon-badges.demolab.com/badge/Exe-x64-2d7d9a.svg?logo=windows11)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-Windows-x64.exe) |
          | Windows x64 Portable | [![windows x64 portable](https://custom-icon-badges.demolab.com/badge/Portable-x64-67b7d1.svg?logo=windows11)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-Windows-x64-Portable.zip) |
          | Linux amd64 | [![Linux amd64](https://img.shields.io/badge/Linux-amd64-f84e29.svg?logo=linux)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-Linux-amd64) |
          | Linux amd64 DEB | [![Linux amd64 DEB](https://img.shields.io/badge/DebPackage-amd64-FF9966.svg?logo=debian)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-Linux-amd64.deb) |
          | Linux arm64 | [![Linux arm64](https://img.shields.io/badge/Linux-arm64-1E4CC9.svg?logo=linux)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-Linux-arm64) |
          | Linux arm64 DEB | [![Linux arm64 DEB](https://img.shields.io/badge/DebPackage-arm64-6683D2.svg?logo=debian)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-Linux-arm64.deb) |
          | macOS amd64 | [![macOS amd64](https://img.shields.io/badge/DMG-Intel_amd64-%2300A9E0.svg?logo=apple)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-macOS-amd64.dmg) |
          | macOS arm64 | [![macOS arm64](https://img.shields.io/badge/DMG-Apple_Silicon-%23000000.svg?logo=apple)](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/VpngateClient-macOS-arm64.dmg) |

          ## ðŸ”§ Installation

          ### Windows
          - Single file: Download `.exe` and run directly
          - Portable: Download `.zip`, extract and run `VpngateClient-Windows-Portable-x64.exe`
          - Require admin privileges, allow it

          ### Linux
          - Executable: 
            Download and `chmod +x VpngateClient-Linux-amd64` or `VpngateClient-Linux-arm64`
            run `sudo ./VpngateClient-Linux-amd64`

          - DEB: 
            `sudo dpkg -i VpngateClient-Linux-amd64.deb` or `VpngateClient-Linux-arm64.deb`

          ### macOS
          - Download `.dmg`, open and drag app to Applications

          EOF

          # è®¾ç½®é¢„å‘å¸ƒæ ‡å¿—ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          PRERELEASE_FLAG=""
          if [ "${{ steps.pre_release_check.outputs.is_prerelease }}" = "true" ]; then
            PRERELEASE_FLAG="--prerelease"
            echo "åˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬: ${{ github.ref_name }}"
          else
            echo "åˆ›å»ºæ­£å¼ç‰ˆæœ¬: ${{ github.ref_name }}"
          fi

          # ä¸€æ¬¡æ€§åˆ›å»ºå‘å¸ƒ
          gh release create ${{ github.ref_name }} \
            --title "${{ github.ref_name }}" \
            --notes-file RELEASE_NOTES.md \
            --draft=false \
            $PRERELEASE_FLAG \
            "${FILES[@]}"
        shell: bash
